import streamlit as st
import google.generativeai as genai
import pydeck as pdk
import pandas as pd
from datetime import date
import random

# CONFIGURA√á√ÉO DA P√ÅGINA
st.set_page_config(page_title="BioGlobe Expert - IA", layout="wide")

# CONFIGURA√á√ÉO DA IA (GEMINI) - Substitui pela tua chave ou usa secrets
# st.secrets["GOOGLE_API_KEY"] deve ser configurado no Streamlit Cloud
try:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
    model = genai.GenerativeModel('gemini-pro')
except:
    st.error("Por favor, configura a GOOGLE_API_KEY nos Secrets do Streamlit.")

# INICIALIZA√á√ÉO DO ESTADO DA SESS√ÉO (Hist√≥rico, Notas, Favoritos)
if 'historico' not in st.session_state:
    st.session_state.historico = []
if 'notas' not in st.session_state:
    st.session_state.notas = ""
if 'favoritos' not in st.session_state:
    st.session_state.favoritos = []

# --- FUN√á√ïES DE IA ---
def consultar_ia(prompt):
    try:
        response = model.generate_content(prompt)
        return response.text
    except:
        return "Erro ao conectar com a base de dados mundial. Verifica a liga√ß√£o."

# --- SIDEBAR (Navega√ß√£o e Pop-up Di√°rio) ---
st.sidebar.title("üêæ BioGlobe Navigation")

# Pop-up Di√°rio (Simulado com expander)
hoje = date.today().strftime("%d/%m/%Y")
st.sidebar.info(f"üìÖ Facto Animal de Hoje: {hoje}")
with st.sidebar.expander("Ver Esp√©cie do Dia"):
    especie_dia = "Lince-Ib√©rico (Lynx pardinus)"
    st.write(f"**{especie_dia}**")
    st.write("√â o felino mais amea√ßado do mundo, nativo da Pen√≠nsula Ib√©rica.")

menu = st.sidebar.radio("Ir para:", ["Globo Interativo", "Pesquisa Expert", "Favoritos üêÜ", "Bloco de Notas"])

# --- P√ÅGINA 1: GLOBO INTERATIVO ---
if menu == "Globo Interativo":
    st.title("üåç Explorador Global de Biodiversidade")
    st.write("Clica ou visualiza uma coordenada para descobrir esp√©cies locais (IA Geogr√°fica).")

    # Configura√ß√£o do Globo usando PyDeck
    view_state = pdk.ViewState(latitude=38.7, longitude=-9.1, zoom=1, pitch=0)
    
    # Camada interativa (Pontos representativos de Continentes/Cidades)
    data = pd.DataFrame({
        'name': ['Lisboa', 'Amaz√≥nia', 'Serengeti', 'Sydney', 'T√≥quio'],
        'lat': [38.7223, -3.4653, -2.3333, -33.8688, 35.6895],
        'lon': [-9.1393, -62.2159, 34.8333, 151.2093, 139.6917]
    })

    layer = pdk.Layer(
        "ScatterplotLayer",
        data,
        get_position='[lon, lat]',
        get_color='[200, 30, 0, 160]',
        get_radius=500000,
        pickable=True,
    )

    r = pdk.Deck(layers=[layer], initial_view_state=view_state, tooltip={"text": "{name}"})
    st.pydeck_chart(r)

    local = st.text_input("Ou digita o nome de uma Cidade/Pa√≠s para a IA analisar:")
    if local:
        with st.spinner(f"A analisar fauna em {local}..."):
            res = consultar_ia(f"Lista 3 animais comuns e 2 raros na regi√£o de {local}. Inclui nomes cient√≠ficos e classe.")
            st.markdown(res)
            st.session_state.historico.append(f"Globo: {local}")

# --- P√ÅGINA 2: PESQUISA EXPERT ---
elif menu == "Pesquisa Expert":
    st.title("üîç Pesquisa Avan√ßada por Classe e Nome")
    
    col1, col2 = st.columns(2)
    with col1:
        classe = st.selectbox("Classe:", ["Mam√≠feros", "Aves", "R√©pteis", "Anf√≠bios", "Peixes", "Invertebrados"])
    with col2:
        animal_busca = st.text_input("Nome do animal (comum ou cient√≠fico):")

    if st.button("Consultar Base de Dados IA"):
        prompt = f"D√°-me informa√ß√µes sobre o animal {animal_busca} da classe {classe}. Inclui: Nome Cient√≠fico, Habitat e Curiosidade."
        resultado = consultar_ia(prompt)
        st.subheader(f"Resultados para: {animal_busca}")
        st.write(resultado)
        
        st.session_state.historico.append(f"Pesquisa: {animal_busca} ({classe})")
        
        if st.button("Adicionar aos Favoritos üêÜ"):
            st.session_state.favoritos.append(f"{animal_busca} - {classe}")
            st.success("Adicionado!")

# --- P√ÅGINA 3: FAVORITOS ---
elif menu == "Favoritos üêÜ":
    st.title("üêÜ Os Meus Favoritos (Animal Print Style)")
    if not st.session_state.favoritos:
        st.write("Ainda n√£o tens animais favoritos.")
    else:
        for fav in st.session_state.favoritos:
            st.markdown(f"### ‚ù§Ô∏è {fav}")
            st.divider()

# --- P√ÅGINA 4: BLOCO DE NOTAS E HIST√ìRICO ---
elif menu == "Bloco de Notas":
    st.title("üìù Registos e Notas de Campo")
    
    st.subheader("O meu Di√°rio de Biodiversidade")
    st.session_state.notas = st.text_area("Escreve aqui as tuas observa√ß√µes:", value=st.session_state.notas, height=200)
    
    st.divider()
    st.subheader("üìú Hist√≥rico de Pesquisas")
    for item in reversed(st.session_state.historico):
        st.write(f"- {item}")

# --- RODAP√â ANTI-HACKER ---
st.sidebar.markdown("---")
st.sidebar.caption("üîí Seguran√ßa: Encripta√ß√£o de ponta-a-ponta Google SSL.")